---
title: "demo-model"
author: "Greg Lenane"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(knitr)
library(tidyverse)
library(odbc)
library(DBI)
library(glue)
library(dplyr)
library(tidyr)
library(dbplyr)
library(lubridate)
library(ggplot2)
library(plotly)
library(scales)
library(openxlsx)
library(readxl)

knitr::opts_chunk$set(echo = TRUE, warning = FALSE, 
                      message = FALSE,
                      fig.width = 17, fig.height = 10)

# OAO_PRODUCTION DB connection
con_prod <- dbConnect(odbc(), "OAO_PRODUCTION")
# capacity modeling path
cap_dir <- "J:/deans/Presidents/SixSigma/Project Based/System/Capacity Modeling/"

# excel wb function
add_to_wb <- function(df, sheetname, add_filter = FALSE) {
  # create sheet name
  sheet <- addWorksheet(wb, sheetname)
  
  setColWidths(wb, sheet, cols = 1:ncol(df), widths = "auto")
  
  # write data to sheet
  writeDataTable(wb,
                 x = df,
                 sheet = sheet,
                 keepNA = FALSE,
                 withFilter = add_filter)
  
  #create cell styles
  header_style <- createStyle(fgFill = "grey", halign = "left", 
                             textDecoration = "bold", fontColour = "#010101")
  body_style <- createStyle(border = "TopBottomLeftRight")
  
  # apply cell styles
  addStyle(wb, sheet, header_style, rows = 1, 
           cols = 1:ncol(df), gridExpand = TRUE, stack = TRUE)
  addStyle(wb, sheet, body_style, rows = 1:(nrow(df) + 1),
           cols = 1:ncol(df), gridExpand = TRUE, stack = TRUE)
  
}
```

```{r sinai colors, include=FALSE} 
# Sinai color scheme
mshs_colors <- c("#221F72", "#00AEFF", "#D80B8C", "#7F7F7F", "#000000", "#800080", "#FFFF00", "#CC0000", "#38761D", "#F39C12")
```

# Set Scenario Variables
```{r set scenario}

# set hospitals in scenario
hospitals <- list(
  "MSH",
  "MSM"
)

# set of services to be swapped in scenario
services <- list(
  "CARDIOLOGY",
  "CARDIOVASCULAR SURGERY"
)
```

# Read Processing
```{r dataset list}
# read in bed capacity (tableau)
# List all CSV files in the directory
bed_cap_csv <- list.files(paste0(cap_dir, "Tableau Data/Bed Capacity/"),
                          pattern = "\\.csv$", full.names = TRUE)
bed_cap <- bed_cap_csv %>%
  map_dfr(~ read_csv(.x) %>% mutate(source_file = basename(.x))) %>%
  rename(HOSPITAL = Location,
         SERVICE_GROUP = `Service Group`,
         MEASURE = `Measure Names`,
         SERVICE_MONTH = `Day of Census Start`) %>%
  filter(MEASURE == 'Avg Total Beds') %>%
  mutate(
    HOSPITAL = case_when(
      HOSPITAL == "MOUNT SINAI BETH ISRAEL" ~ "MSBI",
      HOSPITAL == "MOUNT SINAI BROOKLYN" ~ "MSB",
      HOSPITAL == "MOUNT SINAI MORNINGSIDE" ~ "MSM",
      HOSPITAL == "MOUNT SINAI QUEENS" ~ "MSQ",
      HOSPITAL == "MOUNT SINAI WEST" ~ "MSW",
      HOSPITAL == "THE MOUNT SINAI HOSPITAL" ~ "MSH"),
    SERVICE_MONTH = mdy(SERVICE_MONTH)) %>%
  group_by(HOSPITAL, SERVICE_GROUP, SERVICE_MONTH) %>%
  summarise(AVG_BED_CAPACITY = sum(`Measure Values`, na.rm = TRUE))

# read in processed data from data refresh script
datasets_processed <- list(
  "baseline" = tbl(con_prod, "IPCAP_PROCESSED_DATA") %>%
    mutate(
      SERVICE_DATE = TO_DATE(SERVICE_DATE, 'YYYYMMDD'),
      SERVICE_MONTH = sql("TRUNC(TO_DATE(SERVICE_DATE, 'YYYYMMDD'), 'MM')"),
      FACILITY_MSX = case_when(
        FACILITY_MSX == 'STL' ~ 'MSM',
        FACILITY_MSX == 'RVT' ~ 'MSW',
        FACILITY_MSX == 'BIB' ~ 'MSB',
        FACILITY_MSX == 'BIP' ~ 'MSBI',
        TRUE ~ FACILITY_MSX)),
  "scenario" = tbl(con_prod, "IPCAP_PROCESSED_DATA") %>%
    mutate(
      SERVICE_DATE = TO_DATE(SERVICE_DATE, 'YYYYMMDD'),
      SERVICE_MONTH = sql("TRUNC(TO_DATE(SERVICE_DATE, 'YYYYMMDD'), 'MM')"),
      FACILITY_MSX = case_when(
        FACILITY_MSX == 'STL' ~ 'MSM',
        FACILITY_MSX == 'RVT' ~ 'MSW',
        FACILITY_MSX == 'BIB' ~ 'MSB',
        FACILITY_MSX == 'BIP' ~ 'MSBI',
        TRUE ~ FACILITY_MSX),
      FACILITY_MSX = case_when(
        FACILITY_MSX == local(hospitals[[1]]) & VERITY_DEPT_DESC_SRC == local(services[[2]]) ~ "MSM",
        FACILITY_MSX == local(hospitals[[2]]) & VERITY_DEPT_DESC_SRC == local(services[[1]]) ~ "MSH",
        TRUE ~ FACILITY_MSX)))
```

### IP Demand & Utilization
```{r ip}

# get billing descripions for IP categories
ip_mapping <- tbl(con_prod, "IPCAP_BILLING_CAT_DESC") %>%
  filter(CATEGORY == "IP") %>%
  collect() %>%
  pull(BILLING_CAT_DESC)

# filter data down to IP bed charges in desired date range
ip_utilization <- lapply(datasets_processed, function(df) {
  df %>%
    filter(!is.na(EXTERNAL_NAME),
           BILLING_CAT_DESC == ip_mapping) %>%
    group_by(FACILITY_MSX, SERVICE_GROUP, SERVICE_MONTH, SERVICE_DATE) %>%
    summarise(DAILY_DEMAND = sum(QUANTITY), .groups = "drop") %>%
    collect() %>%
    left_join(bed_cap, by = c("FACILITY_MSX" = "HOSPITAL", 
                              "SERVICE_GROUP" = "SERVICE_GROUP",
                              "SERVICE_MONTH" = "SERVICE_MONTH")) %>%
    mutate(UTILIZATION = DAILY_DEMAND/AVG_BED_CAPACITY,
           UTILIZATION_90 = case_when(
             UTILIZATION > .90 ~ TRUE,
             TRUE ~ FALSE),
           UTILIZATION_95 = case_when(
             UTILIZATION > .95 ~ TRUE,
             TRUE ~ FALSE))
})
```

### Lab & Radiology Demand
```{r lab & radiology demand}

# hospitals vector
hospitals_vec <- unlist(hospitals)

# lab demand
lab_demand <- list()
for (i in 1:length(datasets_processed)) {
  lab_demand[[i]] <- datasets_processed[[i]] %>%
    filter(FACILITY_MSX %in% hospitals_vec) %>%
    filter(LAB_COUNT == 1) %>%
    group_by(FACILITY_MSX, SERVICE_MONTH, SERVICE_DATE, CPT_HCPCS_C, DESCRIPTION_SHORT) %>%
    summarise(DEMAND = sum(QUANTITY)) %>%
    collect() %>%
    mutate(CATEGORY = "LAB",
           DATASET = names(datasets_processed)[i])
  names(lab_demand)[i] <- names(datasets_processed)[i]
}

# rad demand
rad_demand <- list()
for (i in 1:length(datasets_processed)) {
  rad_demand[[i]] <- datasets_processed[[i]] %>%
    filter(FACILITY_MSX %in% hospitals_vec,
           CATEGORY == "RAD",
           CPT_COUNT == 1) %>%
    group_by(FACILITY_MSX, SERVICE_MONTH, SERVICE_DATE, CPT_HCPCS_C, DESCRIPTION_SHORT) %>%
    summarise(DEMAND = sum(QUANTITY)) %>%
    collect() %>%
    mutate(CATEGORY = "RAD",
           DATASET = names(datasets_processed)[i])
  names(rad_demand)[i] <- names(datasets_processed)[i]
}

# comparison of average lab/rad charges for all baseline verity departments
lab_baseline_comp <- datasets_processed[["baseline"]] %>%
  filter(FACILITY_MSX %in% hospitals_vec,
         LAB_COUNT == 1) %>%
  group_by(FACILITY_MSX, VERITY_DEPT_DESC_SRC, ENCOUNTER_NO) %>%
  summarise(SUM_LAB = sum(QUANTITY)) %>%
  group_by(FACILITY_MSX, VERITY_DEPT_DESC_SRC) %>%
  summarise(AVG_LAB = mean(SUM_LAB)) %>%
  arrange(VERITY_DEPT_DESC_SRC) %>%
  collect()

# comparison
rad_baseline_comp <- datasets_processed[["baseline"]] %>%
  filter(FACILITY_MSX %in% hospitals_vec,
         CATEGORY == "RAD",
         CPT_COUNT == 1) %>%
  group_by(FACILITY_MSX, VERITY_DEPT_DESC_SRC, ENCOUNTER_NO) %>%
  summarise(SUM_RAD = sum(QUANTITY)) %>%
  group_by(FACILITY_MSX, VERITY_DEPT_DESC_SRC) %>%
  summarise(AVG_RAD = mean(SUM_RAD)) %>%
  arrange(VERITY_DEPT_DESC_SRC) %>%
  collect()

# combine all and remove individual dfs
lab_rad_demand <- rbind(
  lab_demand[["baseline"]],
  lab_demand[["scenario"]],
  rad_demand[["baseline"]],
  rad_demand[["scenario"]]
)

rm(lab_demand, rad_demand)
```

# Scenario Outputs
## Inpatient
### IP Demand & Utilization Comparison
```{r ip comparison}

# compare utilization of baseline and scenario at daily level
ip_comparison_daily <- ip_utilization[["baseline"]] %>%
  full_join(ip_utilization[["scenario"]],
            by = c("FACILITY_MSX"="FACILITY_MSX",
                   "SERVICE_GROUP"="SERVICE_GROUP",
                   "SERVICE_MONTH"="SERVICE_MONTH",
                   "SERVICE_DATE"="SERVICE_DATE",
                   "AVG_BED_CAPACITY"="AVG_BED_CAPACITY"),
            suffix = c("_BASELINE", "_SCENARIO")) %>%
  filter(FACILITY_MSX %in% hospitals)

# aggregate comparison at monthly level
ip_comparison_monthly <- ip_comparison_daily %>%
  group_by(FACILITY_MSX, SERVICE_GROUP, SERVICE_MONTH, AVG_BED_CAPACITY) %>%
  summarise(AVG_DAILY_DEMAND_BASELINE = mean(DAILY_DEMAND_BASELINE),
            AVG_DAILY_DEMAND_SCENARIO = mean(DAILY_DEMAND_SCENARIO),
            AVG_UTILIZATION_BASELINE = mean(UTILIZATION_BASELINE),
            AVG_UTILIZATION_SCENARIO = mean(UTILIZATION_SCENARIO),
            PERCENT_90_BASELINE = mean(UTILIZATION_90_BASELINE),
            PERCENT_90_SCENARIO = mean(UTILIZATION_90_SCENARIO),
            PERCENT_95_BASELINE = mean(UTILIZATION_95_BASELINE),
            PERCENT_95_SCENARIO = mean(UTILIZATION_95_SCENARIO)) %>%
  mutate(across(where(is.numeric), \(x) coalesce(x, 0))) %>%
  mutate(AVG_UTILIZATION_SCENARIO = if_else(AVG_UTILIZATION_SCENARIO == 0, Inf, AVG_UTILIZATION_SCENARIO))

# aggregate comparison at total level
ip_comparison_total <- ip_comparison_monthly %>%
  group_by(FACILITY_MSX, SERVICE_GROUP) %>% 
  summarise(AVG_DAILY_DEMAND_BASELINE = mean(AVG_DAILY_DEMAND_BASELINE),
            AVG_DAILY_DEMAND_SCENARIO = mean(AVG_DAILY_DEMAND_SCENARIO),
            AVG_UTILIZATION_BASELINE =  mean(AVG_UTILIZATION_BASELINE),
            AVG_UTILIZATION_SCENARIO =  mean(AVG_UTILIZATION_SCENARIO),
            AVG_PERCENT90_BASELINE = mean(PERCENT_90_BASELINE),
            AVG_PERCENT90_SCENARIO = mean(PERCENT_90_SCENARIO),
            AVG_PERCENT95_BASELINE = mean(PERCENT_95_BASELINE),
            AVG_PERCENT95_SCENARIO = mean(PERCENT_95_SCENARIO),
            AVG_BED_CAPACITY = mean(AVG_BED_CAPACITY),
            AVG_VARIANCE_BASELINE = AVG_DAILY_DEMAND_BASELINE - AVG_BED_CAPACITY,
            AVG_VARIANCE_SCENARIO = AVG_DAILY_DEMAND_SCENARIO - AVG_BED_CAPACITY)

rm(ip_utilization)
``` 

### IP Utilization Output
```{r utilization output}

# create table for output
ip_utilization_output <- ip_comparison_total %>%
  pivot_wider(id_cols = SERVICE_GROUP,
              names_from = FACILITY_MSX,
              values_from = c(AVG_BED_CAPACITY,
                              AVG_DAILY_DEMAND_BASELINE,
                              AVG_DAILY_DEMAND_SCENARIO,
                              AVG_UTILIZATION_BASELINE,
                              AVG_UTILIZATION_SCENARIO,
                              AVG_PERCENT90_BASELINE,
                              AVG_PERCENT90_SCENARIO,
                              AVG_PERCENT95_BASELINE,
                              AVG_PERCENT95_SCENARIO,
                              AVG_VARIANCE_BASELINE,
                              AVG_VARIANCE_SCENARIO)) %>%
  select(SERVICE_GROUP, contains(hospitals[[1]]), contains(hospitals[[2]])) 
```

## Lab & Radiology
### Lab & Rad Scenario Comparison
```{r lab & rad scenario comparison}

# create table for output
lab_rad_output <- lab_rad_demand %>%
  filter(FACILITY_MSX %in% hospitals) %>%
  group_by(FACILITY_MSX, SERVICE_MONTH, CATEGORY, DATASET) %>%
  summarise(DEMAND = sum(DEMAND)) %>%
  pivot_wider(id_cols = c(FACILITY_MSX, SERVICE_MONTH, CATEGORY),
              names_from = DATASET,
              values_from = DEMAND) %>%
  mutate(PERCENT_CHANGE = (scenario - baseline)/baseline,
         COUNT_BASELINE = baseline,
         COUNT_SCENARIO = scenario) %>%
  pivot_wider(id_cols = SERVICE_MONTH,
              names_from = c(CATEGORY, FACILITY_MSX),
              values_from = c(COUNT_BASELINE, 
                              COUNT_SCENARIO,
                              PERCENT_CHANGE)) %>%
  select(SERVICE_MONTH, contains("LAB"), contains("RAD")) %>%
  select(SERVICE_MONTH, contains(hospitals[[1]]), contains(hospitals[[2]]))

```

### Lab & Rad Baseline Comparison
```{r lab & rad baseline comparison}

# create table for output
lab_rad_baseline_comp <- lab_baseline_comp %>%
  left_join(rad_baseline_comp, by = c("FACILITY_MSX"="FACILITY_MSX",
                                     "VERITY_DEPT_DESC_SRC"="VERITY_DEPT_DESC_SRC"))
```

## Excel WB
```{r excel workbook}

# create excel workbook for model outputs
wb <- createWorkbook()

# add sheet with IP Utilization Output
add_to_wb(df = ip_utilization_output,
          sheetname = "IP Utilization Comparison")
# add sheet with daily IP Stats
add_to_wb(df = ip_comparison_daily,
          sheetname = "IP Stats Daily",
          add_filter = TRUE)
# add sheet with daily Lab & Rad Stats
add_to_wb(df = lab_rad_output,
          sheetname = "LAB & RAD Demand")
# add sheet with avg charges per patient
add_to_wb(df = lab_rad_baseline_comp,
          sheetname = "LAB & RAD Patient Charges",
          add_filter = TRUE)
# add sheet with daily Lab & Rad Stats
add_to_wb(df = lab_rad_demand,
          sheetname = "LAB & RAD Daily",
          add_filter = TRUE)

saveWorkbook(wb, 
             file = paste0(cap_dir, "Model Outputs/Workbooks/OUTPUT_",
                           hospitals[[1]], services[[1]], "-",
                           hospitals[[2]], services[[2]],"_", Sys.Date(), ".xlsx"),
             overwrite = TRUE )
```

## Visualizations
### Total Utilization Baseline vs. Scenario
```{r total utilization}
total_utilization <- ip_comparison_daily %>%
  group_by(FACILITY_MSX, SERVICE_DATE) %>%
  summarise(BASELINE = sum(DAILY_DEMAND_BASELINE, na.rm = TRUE)/sum(AVG_BED_CAPACITY, na.rm = TRUE),
            SCENARIO = sum(DAILY_DEMAND_SCENARIO, na.rm = TRUE)/sum(AVG_BED_CAPACITY, na.rm = TRUE)) %>%
  mutate(SERVICE_DATE = as.Date(SERVICE_DATE)) %>%
  pivot_longer(cols = c(BASELINE, SCENARIO),
               names_to = "Dataset",
               values_to = "Utilization")


ggplot(total_utilization, aes(x = SERVICE_DATE, y = Utilization, color = Dataset)) +
  geom_smooth(method = "loess", se = FALSE, span = 0.08, linewidth = 1.2) +
  facet_wrap(~ FACILITY_MSX) +
  scale_y_continuous(labels = scales::percent) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  scale_color_manual(values = mshs_colors) + 
  labs(title = "Utilization Over Time by Hospital",
       x = "Service Date",
       y = "Utilization",
       color = "Dataset") +
  theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 14, face = "bold"))


```


### Baseline vs. Scenario IP Utilization
```{r baseline vs. scenario}

# get list of service groups effected by scenario
service_change <- ip_comparison_total %>%
  filter(AVG_UTILIZATION_BASELINE != AVG_UTILIZATION_SCENARIO) %>%
  ungroup() %>%
  distinct(SERVICE_GROUP) %>%
  pull()

# prep data from graph
results_long <- ip_comparison_monthly %>%
  filter(SERVICE_GROUP %in% service_change) %>%
  pivot_longer(
    cols = c(AVG_UTILIZATION_BASELINE, AVG_UTILIZATION_SCENARIO),
    names_to = "Scenario",
    values_to = "Utilization") %>%
  mutate(
    SERVICE_MONTH = as.Date(SERVICE_MONTH),
    Scenario = case_when(
      Scenario == "AVG_UTILIZATION_BASELINE" ~ "Baseline",
      Scenario == "AVG_UTILIZATION_SCENARIO" ~ "Scenario"),
    Utilization = case_when(
      Scenario == "Scenario" & is.na(Utilization) ~ 1,
      TRUE ~ Utilization))

# Plot
ggplot(results_long, aes(x = SERVICE_MONTH, y = Utilization, fill = Scenario)) +
  geom_bar(stat = "identity", position = "dodge") +
  geom_hline(yintercept = .95, color = "black", linetype = "solid", linewidth = 0.7) +
  scale_y_continuous(limits = c(0, 1.5), labels = scales::percent) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  scale_fill_manual(values = mshs_colors) + 
  facet_grid(FACILITY_MSX ~ SERVICE_GROUP) +
  labs(title = "Inpatient Utilization Comparison",
       x = "Service Month",
       y = "Utilization",
       fill = "Scenario") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text(hjust = 0.5),
        panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
        strip.text = element_text(face = "bold"))
```

### Daily Scenario IP Utilization
```{r scenario utilization}

# Plot
ggplot(ip_comparison_daily %>%
         mutate(SERVICE_DATE = as.Date(SERVICE_DATE)), 
       aes(x = SERVICE_DATE,
           y = UTILIZATION_SCENARIO,
           color = SERVICE_GROUP,
           group = SERVICE_GROUP)
       ) +
geom_smooth(se = FALSE, method = "loess", span = 0.1, linewidth = 1.2) +
geom_hline(yintercept = 0.95, color = "black", linewidth = 1.2) +
facet_wrap(~ FACILITY_MSX) +
scale_y_continuous(labels = scales::percent_format(accuracy = 1), limits = c(0, 1.3)) +
scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
scale_color_manual(name = "Service Group", values = mshs_colors) +   
labs(
  title = "Daily Utilization (Scenario)",
  x = "Service Date",
  y = "Utilization (Scenario)"
) +
theme_minimal() +
theme(
  legend.position = "bottom",
  plot.title = element_text(hjust = 0.5),
  axis.text.x = element_text(angle = 45, hjust = 1),
  strip.text = element_text(face = "bold"),
  panel.border = element_rect(color = "black", fill = NA)
)
```
### Daily Lab Demand
```{r lab daily trend}

# data
results_lab <- lab_rad_demand %>%
  filter(FACILITY_MSX %in% hospitals,
         CATEGORY == "LAB") %>%
  group_by(FACILITY_MSX, SERVICE_DATE, DATASET) %>%
  summarise(DEMAND = sum(DEMAND)) %>%
  mutate(SERVICE_DATE = as.Date(SERVICE_DATE))

# visualization
ggplot(results_lab, aes(x = SERVICE_DATE, y = DEMAND, color = DATASET, group = DATASET)) +
  geom_smooth(se = FALSE, method = "loess", span = 0.1, linewidth = 1.2, alpha = 0.9) +
  facet_grid(~ FACILITY_MSX, scales = "free_y") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  scale_color_manual(values = mshs_colors) +
  labs(
    title = "Baseline vs. Scenario Lab Demand",
    x = "Date",
    y = "Demand",
    color = "Dataset"
  ) +
  theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 14, face = "bold"))
```

### Daily Radiology Demand
```{r rad daily trend}

# data
results_rad <- lab_rad_demand %>%
  filter(FACILITY_MSX %in% hospitals,
         CATEGORY == "RAD") %>%
  group_by(FACILITY_MSX, SERVICE_DATE, DATASET) %>%
  summarise(DEMAND = sum(DEMAND)) %>%
  mutate(SERVICE_DATE = as.Date(SERVICE_DATE))

# visualization
ggplot(results_rad, aes(x = SERVICE_DATE, y = DEMAND, color = DATASET, group = DATASET)) +
  geom_smooth(se = FALSE, method = "loess", span = 0.1, linewidth = 1.2, alpha = 0.9) +
  facet_grid(~ FACILITY_MSX, scales = "free_y") +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  scale_color_manual(values = mshs_colors) +
  labs(
    title = "Baseline vs. Scenario Radiology Demand",
    x = "Date",
    y = "Demand",
    color = "Dataset"
  ) +
  theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 14, face = "bold"))
```

# Quality Checks
### Epic Encounter Check
```{r encounter check}

# OAO_PRODUCTION DB connection
con_prod <- dbConnect(odbc(), "OAO Cloud DB Production")

msx_encounters <- glue(
  "SELECT DISTINCT EPIC_CSN
   FROM MSX_IP_OUTPUT
   WHERE DSCH_DT_SRC BETWEEN DATE '2024-06-01' AND DATE '2024-12-31' OR
         ADMIT_DT_SRC BETWEEN DATE '2024-06-01' AND DATE '2024-12-31' AND 
         FACILITY_MSX <> 'MSSN';")

oe_encounters <- glue(
  "WITH ip AS (
       SELECT *
       FROM MSX_IP_OUTPUT
       WHERE DSCH_DT_SRC BETWEEN DATE '2024-06-01' AND DATE '2024-12-31' OR
             ADMIT_DT_SRC BETWEEN DATE '2024-06-01' AND DATE '2024-12-31' AND 
             FACILITY_MSX <> 'MSSN'
   ),
   charge AS (
       select *
       from OE_CHARGE_DETAIL
       where PRIM_ENC_CSN_ID IN (SELECT EPIC_CSN FROM ip))
  select distinct PRIM_ENC_CSN_ID from charge"
)

# create, execute and clear result for MSX IP Encounters
msx_send <- dbSendQuery(con_prod, msx_encounters)
msx <- dbFetch(msx_send)
dbClearResult(msx_send)

# create, execute and clear result for MSX IP Encounters
oe_send <- dbSendQuery(con_prod, oe_encounters)
oe <- dbFetch(oe_send)
dbClearResult(oe_send)

percent_of_encounters <- 
  (length(msx$EPIC_CSN) - length(setdiff(msx$EPIC_CSN, oe$PRIM_ENC_CSN_ID)))/length(msx$EPIC_CSN) 

print(percent_of_encounters)

```

### Bed Charges Over Time
```{r bed charges trend}

# trend bed charges (total) over time
run_rate <- datasets_processed[["baseline"]] %>%
  filter(BILLING_CAT_DESC == 'BED CHARGES') %>%
  group_by(SERVICE_DATE) %>%
  summarise(count = n()) %>%
  collect() %>%
  mutate(SERVICE_DATE = as.Date(SERVICE_DATE))

ggplot(run_rate, aes(x = SERVICE_DATE, y = count)) +
  #geom_smooth(se = FALSE, method = "loess", span = 0.01, linewidth = 1.2, alpha = 0.9) +
  geom_line(linewidth = 1, color = mshs_colors[1]) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  scale_fill_manual(values = mshs_colors) +
  labs(
    title = "Bed Charge Count Over Time",
    x = "Service Date",
    y = "Count"
  ) +
   theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 14, face = "bold"))
```

### Bed Charges by Hospital Over Time
```{r hosp bed charges trend}

# trend bed charges (total) over time
run_rate <- datasets_processed[["baseline"]] %>%
  filter(BILLING_CAT_DESC == 'BED CHARGES') %>%
  group_by(FACILITY_MSX, SERVICE_DATE) %>%
  summarise(count = n()) %>%
  collect() %>%
  mutate(SERVICE_DATE = as.Date(SERVICE_DATE))

ggplot(run_rate, aes(x = SERVICE_DATE, y = count, color = FACILITY_MSX, group = FACILITY_MSX)) +
  geom_smooth(se = FALSE, method = "loess", span = 0.05, linewidth = 1.2, alpha = 0.9) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  scale_color_manual(values = mshs_colors) +
  labs(
    title = "Bed Charge by Hospital Over Time",
    x = "Service Date",
    y = "Count",
    color = "Hospital"
  ) +
  theme(plot.title = element_text(size = 18, face = "bold", hjust = 0.5),
        axis.title = element_text(size = 14),
        axis.text = element_text(size = 12),
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.title = element_text(size = 14),
        legend.text = element_text(size = 12),
        strip.text = element_text(size = 14, face = "bold"))
```
### Lab Charges Over Time
```{r lab charges overtime}

# comparison of average lab/rad charges for all baseline verity departments
lab_daily_total <- datasets_processed[["baseline"]] %>%
  filter(LAB_COUNT == 1) %>%
  group_by(SERVICE_DATE) %>%
  summarise(LAB_CHARGES = sum(QUANTITY)) %>%
  collect() %>%
  mutate(SERVICE_DATE = as.Date(SERVICE_DATE)) 

ggplot(lab_daily_total, aes(x = SERVICE_DATE, y = LAB_CHARGES)) +
  geom_smooth(se = FALSE, method = "loess", span = 0.15, linewidth = 1.2, alpha = 0.9) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  scale_color_manual(values = mshs_colors) +
  labs(title = "Trend of Lab Charges Over Time",
       x = "Service Date",
       y = "Lab Charges") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(face = "bold"),
        plot.title = element_text(hjust = 0.5))
```

### Rad Charges Over Time
```{r rad charges overtime}

# comparison of average lab/rad charges for all baseline verity departments
rad_daily_total <- datasets_processed[["baseline"]] %>%
  filter(CPT_COUNT == 1,
         CATEGORY == "RAD") %>%
  group_by(SERVICE_DATE) %>%
  summarise(RAD_CHARGES = sum(QUANTITY)) %>%
  collect() %>%
  mutate(SERVICE_DATE = as.Date(SERVICE_DATE)) 

ggplot(rad_daily_total, aes(x = SERVICE_DATE, y = RAD_CHARGES)) +
  geom_smooth(se = FALSE, method = "loess", span = 0.15, linewidth = 1.2, alpha = 0.9) +
  scale_x_date(date_breaks = "1 month", date_labels = "%b %Y") +
  scale_color_manual(values = mshs_colors) +
  labs(title = "Trend of Lab Charges Over Time",
       x = "Service Date",
       y = "Lab Charges") +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        strip.text = element_text(face = "bold"),
        plot.title = element_text(hjust = 0.5))
```