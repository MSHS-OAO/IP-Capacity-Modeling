---
title: "scenario_generator_location_swap"
output: html_document
date: "`r Sys.Date()`"
---

```{r scenario data}

baseline <- tbl(con_prod, "IPCAP_BEDCHARGES") %>% collect()

scenario_generator_location_swap <- function(hospitals, services, percentage_to_hosp1 = 0.9, percentage_to_hosp2 = 0.9) {

  # scenario data staged as replica of baseline
  scenario <- baseline %>%
    mutate(
      SERVICE_DATE = as.Date(SERVICE_DATE, format = "%Y%m%d"),
      SERVICE_MONTH = lubridate::floor_date(SERVICE_DATE, "month"),
      FACILITY_MSX = case_when(
        FACILITY_MSX == 'STL' ~ 'MSM',
        FACILITY_MSX == 'RVT' ~ 'MSW',
        FACILITY_MSX == 'BIB' ~ 'MSB',
        FACILITY_MSX == 'BIP' ~ 'MSBI',
        TRUE ~ FACILITY_MSX
      )
    )
  
  # identify row indexes where patient is at hospial 1 and is in service line 2
  hosp_1_indexes <- which(scenario$FACILITY_MSX == hospitals[[1]]&
                             scenario$VERITY_DIV_DESC_SRC %in% services[[2]])

  # identify row indexes where patient is at hospial 2 and is in service line 1
  hosp_2_indexes <- which(scenario$FACILITY_MSX == hospitals[[2]]&
                           scenario$VERITY_DIV_DESC_SRC %in% services[[1]])
  
  # take percent sample of full list of scenario indedxes and place index samples in list to prep for loop
  sample_rows <- list(
    "hosp_1_sampled_indexes" = sample(hosp_1_indexes, size = floor(length(hosp_1_indexes) * percentage_to_hosp2)),
    "hosp_2_sampled_indexes" = sample(hosp_2_indexes, size = floor(length(hosp_2_indexes) * percentage_to_hosp1)))
  
  # rows to remove
  rows_to_remove <- 
    which((seq_len(nrow(scenario)) %in% sample_rows[[1]] & 
            scenario$SERVICE_GROUP %in% reroute_service_group[[1]]) |
          (seq_len(nrow(scenario)) %in% sample_rows[[2]] &
            scenario$SERVICE_GROUP %in% reroute_service_group[[2]]))
  
  # reset the FACILITY of the scenario patient encounters to their new FACILITY
  scenario <- scenario %>%
    mutate(FACILITY_MSX = case_when(
      row_number() %in% sample_rows$hosp_1_sampled_indexes ~ hospitals[[2]],  # MSH → MSM
      row_number() %in% sample_rows$hosp_2_sampled_indexes ~ hospitals[[1]],  # MSM → MSH
      TRUE ~ FACILITY_MSX))
  
  # create a df for new demand that has been rerouted
  new_demand <- data.frame()
  # loop through each hospital and reroute the demand
  for (hosp in 1:length(reroute_hosp)){
    
    # get sample rows that are also getting rerouted
    reroute_data <- scenario[sample_rows[[hosp]],] %>%
      filter(SERVICE_GROUP %in% reroute_service_group[[hosp]])
    
    # normalize rerouting percentages to 100
    reroute_service_group_percent[[hosp]] <- 
      reroute_service_group_percent[[hosp]]/sum(reroute_service_group_percent[[hosp]])
    
    # determine how many rows will be edited for each service group
    counts <- round(nrow(reroute_data) * reroute_service_group_percent[[hosp]])
    remainder <- nrow(reroute_data) - sum(counts)
    max_service <- names(which.max(counts))
    counts[max_service] <- counts[max_service] + remainder
    
    # randomly apply new service groupings at desired percentages
    new_service <- sample(unlist(mapply(rep, names(counts), counts))) 
    
    # overwrite rerouted df
    reroute_data$SERVICE_GROUP <- new_service
    
    # add rerouted data to new demand df
    new_demand <- rbind(new_demand, reroute_data)
  }
  
  # remove original routing of patients and replace with rerouted data
  scenario <- scenario %>%
    filter(!(row_number() %in% rows_to_remove)) %>%
    rbind(new_demand)
  
  return(scenario)
}



```